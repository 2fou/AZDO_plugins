<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Livrable Control</title>
<script src="https://unpkg.com/azure-devops-extension-sdk@2.0.7/lib/azure-devops-extension-sdk.js"></script>
<style>
label {
    display: block;
    margin: 8px 0;
}
</style>
</head>
<body>
<form id="livrableForm">
<label>
<input type="checkbox" id="question1" /> Le projet implique-t-il un niveau de sécurité élevé?
</label>
<label>
<input type="checkbox" id="question2" /> Est-ce que le projet nécessite une validation légale?
</label>
<div id="commonDeliverable" style="display: none;">
<label>Plan de sécurité (lien):
<input type="url" id="securityPlanUrl" placeholder="http://link-to-security-plan.com" />
</label>
</div>
<div id="additionalDeliverable" style="display: none;">
<label>Validation légale (lien):
<input type="url" id="legalValidationUrl" placeholder="http://link-to-legal-validation.com" />
</label>
</div>
<button type="button" id="saveButton">Enregistrer</button>
</form>
<script>
VSS.init();
VSS.ready(function() {
    VSS.require(["TFS/WorkItemTracking/Services"], function(WorkItemServices) {
        const question1 = document.getElementById('question1');
        const question2 = document.getElementById('question2');
        const commonDeliverable = document.getElementById('commonDeliverable');
        const additionalDeliverable = document.getElementById('additionalDeliverable');
        const saveButton = document.getElementById('saveButton');

        const updateDeliverablesVisibility = () => {
            commonDeliverable.style.display = (question1.checked || question2.checked) ? 'block' : 'none';
            additionalDeliverable.style.display = question2.checked ? 'block' : 'none';
        };

        const updateFields = async (workItemFormService) => {
            try {
                const data = {
                    question1Checked: question1.checked,
                    question2Checked: question2.checked,
                    securityPlanUrl: document.getElementById('securityPlanUrl').value,
                    legalValidationUrl: document.getElementById('legalValidationUrl').value
                };
                let updatedFields = {};
                if (data.question1Checked || data.question2Checked) {
                    updatedFields['Custom.SecurityPlanUrl'] = data.securityPlanUrl;
                }
                if (data.question2Checked) {
                    updatedFields['Custom.LegalValidationUrl'] = data.legalValidationUrl;
                }
                await workItemFormService.setFieldValues(updatedFields);
                console.log('Fields updated successfully');
            } catch (error) {
                console.error('Error updating fields: ', error);
            }
        };

        question1.addEventListener('change', updateDeliverablesVisibility);
        question2.addEventListener('change', updateDeliverablesVisibility);

        saveButton.addEventListener('click', async () => {
            try {
                const workItemFormService = await WorkItemServices.WorkItemFormService.getService();
                await updateFields(workItemFormService);
            } catch (error) {
                console.error('Error getting work item form service:', error);
            }
        });
    });
});
</script>
</body>
</html>